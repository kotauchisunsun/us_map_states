<!DOCTYPE html>
<meta charset="UTF-8">

<style>

.state-borders {
  fill: none;
  stroke: #222;
  stroke-width: 0.3px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

#tooltip-container {
  position: absolute;
  background-color: #fff;
  color: #000;
  padding: 10px;
  border: 1px solid;
  display: none;
}


.tooltip_key {
  font-weight: bold;
}

.tooltip_value {
  margin-left: 20px;
  float: right;
}

.button {
	display: inline-block;
	zoom: 1; /* zoom and *display = ie7 hack for display:inline-block */
	*display: inline;
	vertical-align: baseline;
	margin: 0 2px;
	outline: none;
	cursor: pointer;
	text-align: center;
	text-decoration: none;
	font: 20px/100% Arial, Helvetica, sans-serif;
	padding: .5em 2em .55em;
	text-shadow: 0 1px 1px rgba(0,0,0,.3);
	border-radius: .5em;
	box-shadow: 0 1px 2px rgba(0,0,0,.2);
	width: 150px;
}
.button:hover {
	text-decoration: none;
}
.button:active {
	position: relative;
	top: 1px;
}

.bigrounded {
	border-radius: 2em;
}
.medium {
	font-size: 12px;
	padding: .4em 1.5em .42em;
}
.small {
	font-size: 11px;
	padding: .2em 1em .275em;
}

/* white */
.white {
	color: #606060;
	border: solid 1px #b7b7b7;
	background: #fff;
	filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#ededed');
}
.white:hover {
	background: #ededed;
	filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#dcdcdc');
}
.white:active {
	color: #999;
	filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#ededed', endColorstr='#ffffff');
}
.button:disabled {
	background-color: #666;
	/*cursor: not-allowed;*/
}

</style>
<svg width="960" height="600"></svg>
<div id="tooltip-container"></div>
<br>
	<button class="button white" id='button_main' onClick='draw_main()' disabled="disabled">Start</button>
	<button class="button white" id='button_init' onClick='draw_init()' disabled="disabled">Init</button>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>


// state info
// state: å·žæ˜‡æ ¼å¹´ã‚‚ã—ãã¯åˆ†é›¢å‰ã«æ‰€å±žã—ã¦ã„ãŸå·žãŒæ˜‡æ ¼ã—ãŸå¹´
// territory: æº–å·žè¨­å®šå¹´
// separation: åˆ†é›¢ã—ãŸå¹´ãƒ»
// id: us mapã®id
var state_info_array = [
	 {name: 'ãƒ‡ãƒ©ã‚¦ã‚§ã‚¢å·ž',         state:1787, territory:null, separation: null, id: '10'}
	,{name: 'ãƒšãƒ³ã‚·ãƒ«ãƒ™ãƒ‹ã‚¢å·ž',     state:1787, territory:null, separation: null, id: '42'}
	,{name: 'ãƒ‹ãƒ¥ãƒ¼ã‚¸ãƒ£ãƒ¼ã‚¸ãƒ¼å·ž',   state:1787, territory:null, separation: null, id: '34'}
	,{name: 'ã‚¸ãƒ§ãƒ¼ã‚¸ã‚¢å·ž',         state:1788, territory:null, separation: null, id: '13' }
	,{name: 'ã‚³ãƒãƒã‚«ãƒƒãƒˆå·ž',       state:1788, territory:null, separation: null, id: '09' }
	,{name: 'ãƒžã‚µãƒãƒ¥ãƒ¼ã‚»ãƒƒãƒ„å·ž',   state:1788, territory:null, separation: null, id: '25' }
	,{name: 'ãƒ¡ãƒªãƒ¼ãƒ©ãƒ³ãƒ‰å·ž',       state:1788, territory:null, separation: null, id: '24' }
	,{name: 'ã‚µã‚¦ã‚¹ã‚«ãƒ­ãƒ©ã‚¤ãƒŠå·ž',   state:1788, territory:null, separation: null, id: '45' }
	,{name: 'ãƒ‹ãƒ¥ãƒ¼ãƒãƒ³ãƒ—ã‚·ãƒ£ãƒ¼å·ž', state:1788, territory:null, separation: null, id: '33' }
	,{name: 'ãƒãƒ¼ã‚¸ãƒ‹ã‚¢å·ž',         state:1788, territory:null, separation: null, id: '51' }
	,{name: 'ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯å·ž',       state:1788, territory:null, separation: null, id: '36' }
	,{name: 'ãƒŽãƒ¼ã‚¹ã‚«ãƒ­ãƒ©ã‚¤ãƒŠå·ž',   state:1789, territory:null, separation: null, id: '37' }
	,{name: 'ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰å·ž',   state:1790, territory:null, separation: null, id: '44' }
	,{name: 'ãƒãƒ¼ãƒ¢ãƒ³ãƒˆå·ž',         state:1791, territory:null, separation: null, id: '50' }
	,{name: 'ã‚±ãƒ³ã‚¿ãƒƒã‚­ãƒ¼å·ž',       state:1788, territory:null, separation: 1792, id: '21' }
	,{name: 'ãƒ†ãƒã‚·ãƒ¼å·ž',           state:1796, territory:1790, separation: null, id: '47' }
	,{name: 'ã‚ªãƒã‚¤ã‚ªå·ž',           state:1803, territory:null, separation: null, id: '39' }
	,{name: 'ãƒ«ã‚¤ã‚¸ã‚¢ãƒŠå·ž',         state:1812, territory:1804, separation: null, id: '22' }
	,{name: 'ã‚¤ãƒ³ãƒ‡ã‚£ã‚¢ãƒŠå·ž',       state:1816, territory:1800, separation: null, id: '18' }
	,{name: 'ãƒŸã‚·ã‚·ãƒƒãƒ”å·ž',         state:1817, territory:1798, separation: null, id: '28' }
	,{name: 'ã‚¤ãƒªãƒŽã‚¤å·ž',           state:1818, territory:1809, separation: null, id: '17' }
	,{name: 'ã‚¢ãƒ©ãƒãƒžå·ž',           state:1819, territory:1798, separation: null, id: '01' }
	,{name: 'ãƒ¡ã‚¤ãƒ³å·ž',             state:1788, territory:null, separation: 1820, id: '23' }
	,{name: 'ãƒŸã‚ºãƒ¼ãƒªå·ž',           state:1821, territory:1805, separation: null, id: '29' }
	,{name: 'ã‚¢ãƒ¼ã‚«ãƒ³ã‚½ãƒ¼å·ž',       state:1836, territory:1819, separation: null, id: '05' }
	,{name: 'ãƒŸã‚·ã‚¬ãƒ³å·ž',           state:1837, territory:1805, separation: null, id: '26' }
	,{name: 'ãƒ•ãƒ­ãƒªãƒ€å·ž',           state:1845, territory:1822, separation: null, id: '12' }
	,{name: 'ãƒ†ã‚­ã‚µã‚¹å·ž',           state:1845, territory:null, separation: null, id: '48' }
	,{name: 'ã‚¢ã‚¤ã‚ªãƒ¯å·ž',           state:1846, territory:1837, separation: null, id: '19' }
	,{name: 'ã‚¦ã‚£ã‚¹ã‚³ãƒ³ã‚·ãƒ³å·ž',     state:1848, territory:1836, separation: null, id: '55' }
	,{name: 'ã‚«ãƒªãƒ•ã‚©ãƒ«ãƒ‹ã‚¢å·ž',     state:1850, territory:null, separation: null, id: '06' }
	,{name: 'ãƒŸãƒã‚½ã‚¿å·ž',           state:1858, territory:1849, separation: null, id: '27' }
	,{name: 'ã‚ªãƒ¬ã‚´ãƒ³å·ž',           state:1859, territory:1859, separation: null, id: '41' }
	,{name: 'ã‚«ãƒ³ã‚¶ã‚¹å·ž',           state:1861, territory:1854, separation: null, id: '20' }
	,{name: 'ã‚¦ã‚§ã‚¹ãƒˆãƒãƒ¼ã‚¸ãƒ‹ã‚¢å·ž', state:1788, territory:null, separation: 1863, id: '54' }
	,{name: 'ãƒãƒãƒ€å·ž',             state:1864, territory:1861, separation: null, id: '32' }
	,{name: 'ãƒãƒ–ãƒ©ã‚¹ã‚«å·ž',         state:1867, territory:1854, separation: null, id: '31' }
	,{name: 'ã‚³ãƒ­ãƒ©ãƒ‰å·ž',           state:1876, territory:1861, separation: null, id: '08' }
	,{name: 'ãƒŽãƒ¼ã‚¹ãƒ€ã‚³ã‚¿å·ž',       state:1889, territory:1861, separation: null, id: '38' }
	,{name: 'ã‚µã‚¦ã‚¹ãƒ€ã‚³ã‚¿å·ž',       state:1889, territory:1861, separation: null, id: '46' }
	,{name: 'ãƒ¢ãƒ³ã‚¿ãƒŠå·ž',           state:1889, territory:1864, separation: null, id: '30' }
	,{name: 'ãƒ¯ã‚·ãƒ³ãƒˆãƒ³å·ž',         state:1889, territory:1853, separation: null, id: '53' }
	,{name: 'ã‚¢ã‚¤ãƒ€ãƒ›å·ž',           state:1890, territory:1863, separation: null, id: '16' }
	,{name: 'ãƒ¯ã‚¤ã‚ªãƒŸãƒ³ã‚°å·ž',       state:1890, territory:1868, separation: null, id: '56' }
	,{name: 'ãƒ¦ã‚¿å·ž',               state:1896, territory:1850, separation: null, id: '49' }
	,{name: 'ã‚ªã‚¯ãƒ©ãƒ›ãƒžå·ž',         state:1907, territory:1890, separation: null, id: '40' }
	,{name: 'ãƒ‹ãƒ¥ãƒ¼ãƒ¡ã‚­ã‚·ã‚³å·ž',     state:1912, territory:1850, separation: null, id: '35' }
	,{name: 'ã‚¢ãƒªã‚¾ãƒŠå·ž',           state:1912, territory:1863, separation: null, id: '04' }
	,{name: 'ã‚¢ãƒ©ã‚¹ã‚«å·ž',           state:1959, territory:1912, separation: null, id: '02' }
	,{name: 'ãƒãƒ¯ã‚¤å·ž',             state:1959, territory:1898, separation: null, id: '15' }
];

// å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆ
// year:ç™ºç”Ÿå¹´
// event: ã‚¤ãƒ™ãƒ³ãƒˆå†…å®¹
var event_array = [
	{year: 1607, event: 'âš’ å…¥æ¤é–‹å§‹'}
	,{year: 1767, event: 'âš– ã‚¿ã‚¦ãƒ³ã‚¼ãƒ³ãƒ‰è«¸æ³•æˆç«‹'}
	,{year: 1770, event: 'ðŸ’£ ãƒœã‚¹ãƒˆãƒ³è™æ®ºäº‹ä»¶'}
	,{year: 1773, event: 'ðŸ’£ ãƒœã‚¹ãƒˆãƒ³èŒ¶ä¼šäº‹ä»¶'}
	,{year: 1774, event: 'âš– ç¬¬ä¸€å›žå¤§é™¸ä¼šè­°é–‹å‚¬'}
	,{year: 1775, event: 'ðŸ’£ ã‚¢ãƒ¡ãƒªã‚«ç‹¬ç«‹æˆ¦äº‰é–‹å§‹'}
	,{year: 1783, event: 'ðŸ’£ ã‚¢ãƒ¡ãƒªã‚«ç‹¬ç«‹æˆ¦äº‰çµ‚äº†'}
	,{year: 1788, event: 'ðŸ’£ åˆè¡†å›½ä¼šè­°è¨­ç«‹'}
	,{year: 1789, event: 'ðŸ’£ ãƒ•ãƒ©ãƒ³ã‚¹é©å‘½é–‹å§‹'}
	,{year: 1794, event: 'ðŸ’£ ãƒ•ãƒ©ãƒ³ã‚¹é©å‘½çµ‚äº†'}
	//,{year: 1804, event: 'âš– åŒ—éƒ¨å…¨å·žã§å¥´éš·åˆ¶åº¦å»ƒæ­¢'}
	,{year: 1812, event: 'ðŸ’£ ç±³è‹±æˆ¦äº‰é–‹å§‹'}
	,{year: 1814, event: 'ðŸ’£ ç±³è‹±æˆ¦äº‰çµ‚äº†'}
	,{year: 1820, event: 'âš– ãƒŸã‚ºãƒªãƒ¼å¦¥å”'}
	,{year: 1846, event: 'ðŸ’£ ç±³å¢¨æˆ¦äº‰é–‹å§‹'}
	,{year: 1848, event: 'ðŸ’£ ç±³å¢¨æˆ¦äº‰çµ‚äº†'}
	,{year: 1861, event: 'ðŸ’£ å—åŒ—æˆ¦äº‰é–‹å§‹'}
	,{year: 1862, event: 'âš– ãƒªãƒ³ã‚«ãƒ¼ãƒ³ã«ã‚ˆã‚‹å¥´éš·è§£æ”¾å®£è¨€'}
	,{year: 1865, event: 'ðŸ’£ å—åŒ—æˆ¦äº‰çµ‚äº†'}
	,{year: 1898, event: 'ðŸ’£ ç±³è¥¿æˆ¦äº‰'}
	,{year: 1899, event: 'ðŸ’£ ç±³æ¯”æˆ¦äº‰é–‹å§‹'}
	,{year: 1902, event: 'ðŸ’£ ç±³æ¯”æˆ¦äº‰çµ‚äº†'}
	,{year: 1917, event: 'ðŸ’£ WW1å‚æˆ¦'}
	,{year: 1918, event: 'ðŸ’£ WW1çµ‚äº†'}
	,{year: 1941, event: 'ðŸ’£ WW2å‚æˆ¦'}
	,{year: 1945, event: 'ðŸ’£ WW2çµ‚äº†'}
	,{year: 1950, event: 'ðŸ’£ æœé®®æˆ¦äº‰é–‹å§‹'}
	,{year: 1953, event: 'ðŸ’£ æœé®®æˆ¦äº‰çµ‚äº†'}
	,{year: 1929, event: 'ðŸ’¸ ä¸–ç•Œææ…Œ'}
	,{year: 1848, event: 'ðŸ’¸ ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ©ãƒƒã‚·ãƒ¥'}
	,{year: 1853, event: 'â›´ æ±ã‚¤ãƒ³ãƒ‰è‰¦éšŠã€€æ—¥æœ¬ã«åˆ°é”'}
	,{year: 1959, event: 'ðŸ—º 50å·žæƒã†'}
];

var svg = d3.select("svg");

var path = d3.geoPath();
var sleep_count     = 0;
var start_year      = 1765;
var end_year        = 1959;
//var year_bin        = 30;
var year_bin        = 1;
var timeout         = 1500;
//var timeout         = 10;
var sleep_max_count = (end_year - start_year + 1) * year_bin;
var g_us;
var requestID;
var button_status = 0;

function draw_main() {
	var element_main = document.getElementById('button_main');
	if (button_status == 0) {
    button_status = 1;
		element_main.innerHTML = 'Stop';
		var element_init = document.getElementById('button_init');
		element_init.disabled = true;

		draw_us_map(true);
		
  } else {
		button_status = 0;
		element_main.innerHTML = 'Start';
		clearTimeout(requestID);
		var element_init = document.getElementById('button_init');
		element_init.disabled = false;
	}
	
}
function draw_init() {
	sleep_count = 0;
	clearTimeout(requestID);
	draw_us_map(false);
	var element_init = document.getElementById('button_init');
	element_init.disabled = true;
	var element_main = document.getElementById('button_main');
	element_main.innerHTML = 'Start';
	element_main.disabled = false;
	button_status = 0;
	
}

function draw_us_map(flag) {
	if (sleep_count >= sleep_max_count) {
		var element_init = document.getElementById('button_init');
		element_init.disabled = false;
		var element_main = document.getElementById('button_main');
		element_main.disabled = true;
    return;
  }
	//console.log('y: ' + (sleep_count + start_year));
	svg.selectAll('g').remove();
	svg.selectAll('text').remove();
	svg.selectAll('path').remove();
	//
	var text_array = [];
	svg.append("g")
    .selectAll("path")
    .data(topojson.feature(g_us, g_us.objects.states).features)
    .enter().append("path")
      .attr("d", path)
      .style("fill", function(d) {
					for (var i = 0; i < state_info_array.length; i++) {
						if (d.id == state_info_array[i].id) {
							if (state_info_array[i].separation == null &&
									state_info_array[i].state == Math.floor(sleep_count / year_bin) + start_year) {
								text_array.push({name: state_info_array[i].name, x: d.geometry.coordinates[0][0][0][0], y:d.geometry.coordinates[0][0][0][1]});
              }
							if (state_info_array[i].separation != null &&
									state_info_array[i].separation == Math.floor(sleep_count / year_bin) + start_year) {
								text_array.push({name: state_info_array[i].name, x: d.geometry.coordinates[0][0][0][0], y:d.geometry.coordinates[0][0][0][1]});
              }
							if (state_info_array[i].state <=  Math.floor(sleep_count / year_bin) + start_year) {
                  return "#00f";
              } else if (state_info_array[i].territory != null &&
												 state_info_array[i].territory <=  Math.floor(sleep_count / year_bin) + start_year) {
                  return "#aaf";
              } else {
                  return "#ccc";
							}
            }
					}
      })
			.on("mousemove", function(d) {
            var html = "";
						var state_name = '';
						var state_year = '';
						for (var i = 0; i < state_info_array.length; i++) {
							if (d.id == state_info_array[i].id) {
								state_name = state_info_array[i].name;
								if (state_info_array[i].separation == null) {
                  state_year = state_info_array[i].state;
                } else {
                  state_year = state_info_array[i].separation;
								}
								
								break;
							}
						}
  
            html += "<div class=\"tooltip_key\">";
            html += "<span class=\"tooltip_key\">";
            html += state_name;
            html += "</span>";
            html += "<span class=\"tooltip_value\">";
            html += state_year;
            html += "";
            html += "</span>";
            html += "</div>";
            
            $("#tooltip-container").html(html);
            $(this).attr("fill-opacity", "0.8");
            $("#tooltip-container").show();
            
            var coordinates = d3.mouse(this);
            
            var map_width = 960;
            
            if (d3.event.layerX < map_width / 2) {
              d3.select("#tooltip-container")
                .style("top", (d3.event.layerY + 15) + "px")
                .style("left", (d3.event.layerX + 15) + "px");
            } else {
              var tooltip_width = $("#tooltip-container").width();
              d3.select("#tooltip-container")
                .style("top", (d3.event.layerY + 15) + "px")
                .style("left", (d3.event.layerX - tooltip_width - 30) + "px");
            }
        })
        .on("mouseout", function() {
                $(this).attr("fill-opacity", "1.0");
                $("#tooltip-container").hide();
            });

  svg.append("path")
      .attr("class", "state-borders")
      .attr("d", path(topojson.mesh(g_us, g_us.objects.states, function(a, b) { return a !== b; })));
	if (text_array.length != 0) {
		for (var i = 0; i < text_array.length; i++) {
			svg.append("text")
	    .attr("x", text_array[i].x)
	    .attr("y", text_array[i].y)
	    .attr("fill", "#000")
	    .attr("text-anchor", "start")
	    .attr("font-weight", "bold")
	    .text(text_array[i].name);
		}
  }
	var top_text = '';
	for (var i = 0; i < event_array.length; i++) {
		if (event_array[i].year == Math.floor(sleep_count / year_bin) + start_year) {
            top_text += event_array[i].event;
        }
	}
	svg.append("text")
    //.attr("class", "caption")
    .attr("x", 350)
    .attr("y", 30)
    .attr("fill", "#000")
    .attr("font-size", "24pt")
    .attr("text-anchor", "start")
    .attr("font-weight", "bold")
    .text((Math.floor(sleep_count / year_bin) + start_year) + 'å¹´ ' + top_text);
	svg.append("text")
	    .attr("x", 690)
	    .attr("y", 540)
	    .attr("fill", "#000")
	    .attr("text-anchor", "start")
	    .attr("font-weight", "bold")
	    .text('å·ž');
	svg.append("text")
	    .attr("x", 690)
	    .attr("y", 580)
	    .attr("fill", "#000")
	    .attr("text-anchor", "start")
	    .attr("font-weight", "bold")
	    .text('æº–å·ž');

	sleep_count += 1;
	if (flag == true) {
		//requestID = requestAnimationFrame(draw_us_map);
		requestID = setTimeout(draw_us_map, timeout, true); 
  }

};

d3.json("https://d3js.org/us-10m.v1.json", function(error, us) {
  if (error) throw error;
	g_us = us;
	// sample
	svg.append("rect")
	    .attr("x", 650)
      .attr("y", 520)
		  .attr("width", 30)
		  .attr("height", 30)
		  .attr("fill", '#00f');

	svg.append("rect")
	    .attr("x", 650)
      .attr("y", 560)
		  .attr("width", 30)
		  .attr("height", 30)
		  .attr("fill", '#aaf');

	draw_us_map(false);
	var element_init = document.getElementById('button_main');
	element_init.disabled = false;

});

</script>